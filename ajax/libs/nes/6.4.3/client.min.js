"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(e,t){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"object"===("undefined"==typeof module?"undefined":_typeof(module))?module.exports=t():"function"==typeof define&&define.amd?define(t):"object"===("undefined"==typeof exports?"undefined":_typeof(exports))?exports.nes=t():e.nes=t()}("undefined"!=typeof window?window:global,function(){var e=function(){},t=function(e,t){var n=null,o=null;try{n=JSON.parse(e)}catch(e){o=new s(e,"protocol")}return t(o,n)},n=function(e,t){var n=null,o=null;try{n=JSON.stringify(e)}catch(e){o=new s(e,"user")}return t(o,n)},o=function(e){return function(t){setTimeout(function(){return e(t)},0)}},s=function(e,t){return"string"==typeof e&&(e=new Error(e)),e.type=t,e},i={1e3:"Normal closure",1001:"Going away",1002:"Protocol error",1003:"Unsupported data",1004:"Reserved",1005:"No status received",1006:"Abnormal closure",1007:"Invalid frame payload data",1008:"Policy violation",1009:"Message too big",1010:"Mandatory extension",1011:"Internal server error",1015:"TLS handshake"},r=function(t,n){n=n||{},this._url=t,this._settings=n,this._heartbeatTimeout=!1,this._ws=null,this._reconnection=null,this._reconnectionTimer=null,this._ids=0,this._requests={},this._subscriptions={},this._heartbeat=null,this._packets=[],this._disconnectListeners=null,this._disconnectRequested=!1,this.onError=function(e){return console.error(e)},this.onConnect=e,this.onDisconnect=e,this.onUpdate=e,this.id=null};return r.WebSocket="undefined"==typeof WebSocket?null:WebSocket,r.prototype.connect=function(e,t){return"function"==typeof e&&(t=arguments[0],e={}),this._reconnection?o(t)(new Error("Cannot connect while client attempts to reconnect")):this._ws?o(t)(new Error("Already connected")):(!1!==e.reconnect?this._reconnection={wait:0,delay:e.delay||1e3,maxDelay:e.maxDelay||5e3,retries:e.retries||1/0,settings:{auth:e.auth,timeout:e.timeout}}:this._reconnection=null,void this._connect(e,!0,t))},r.prototype._connect=function(e,t,n){var o=this,c=new r.WebSocket(this._url,this._settings.ws);this._ws=c,clearTimeout(this._reconnectionTimer),this._reconnectionTimer=null;var u=function(e){if(n){var t=n;return n=null,t(e)}return o.onError(e)},a=e.timeout?setTimeout(function(){if(o._cleanup(),u(new s("Connection timed out","timeout")),t)return o._reconnect()},e.timeout):null;c.onopen=function(){return clearTimeout(a),c.onopen=null,o._hello(e.auth,function(e){return e?(e.path&&delete o._subscriptions[e.path],o._disconnect(function(){return u(e)},!0)):(o.onConnect(),u())})},c.onerror=function(e){clearTimeout(a),o._cleanup();var t=new s("Socket error","ws");return u(t)},c.onclose=function(e){c.onopen&&u(new Error("Connection terminated while while to connect"));var t=o._disconnectRequested;o._cleanup();var n={code:e.code,explanation:i[e.code]||"Unknown",reason:e.reason,wasClean:e.wasClean,willReconnect:!!(o._reconnection&&o._reconnection.retries>=1),wasRequested:t};o.onDisconnect(n.willReconnect,n),o._reconnect()},c.onmessage=function(e){return o._onMessage(e)}},r.prototype.overrideReconnectionAuth=function(e){return!!this._reconnection&&(this._reconnection.settings.auth=e,!0)},r.prototype.disconnect=function(t){return t=t||e,this._disconnect(t,!1)},r.prototype._disconnect=function(e,t){this._reconnection=null,clearTimeout(this._reconnectionTimer),this._reconnectionTimer=null;var n=this._disconnectRequested||!t;return this._disconnectListeners?(this._disconnectRequested=n,void this._disconnectListeners.push(e)):!this._ws||this._ws.readyState!==r.WebSocket.OPEN&&this._ws.readyState!==r.WebSocket.CONNECTING?o(e)():(this._disconnectRequested=n,this._disconnectListeners=[e],void this._ws.close())},r.prototype._cleanup=function(){this._ws&&(this._ws.readyState!==r.WebSocket.OPEN&&this._ws.readyState!==r.WebSocket.CONNECTING||this._ws.close(),this._ws.onopen=null,this._ws.onclose=null,this._ws.onerror=e,this._ws.onmessage=null,this._ws=null),this._packets=[],this.id=null,clearTimeout(this._heartbeat),this._heartbeat=null;for(var t=new s("Request failed - server disconnected","disconnect"),n=Object.keys(this._requests),o=0;o<n.length;++o){var i=n[o],c=this._requests[i],u=c.callback;clearTimeout(c.timeout),delete this._requests[i],u(t)}if(this._disconnectListeners){var a=this._disconnectListeners;this._disconnectListeners=null,this._disconnectRequested=!1,a.forEach(function(e){return e()})}},r.prototype._reconnect=function(){var t=this;if(this._reconnection){if(this._reconnection.retries<1)return this._disconnect(e,!0);--this._reconnection.retries,this._reconnection.wait=this._reconnection.wait+this._reconnection.delay;var n=Math.min(this._reconnection.wait,this._reconnection.maxDelay);this._reconnectionTimer=setTimeout(function(){t._connect(t._reconnection.settings,!1,function(e){if(e)return t.onError(e),t._reconnect()})},n)}},r.prototype.request=function(e,t){"string"==typeof e&&(e={method:"GET",path:e});var n={type:"request",method:e.method||"GET",path:e.path,headers:e.headers,payload:e.payload};return this._send(n,!0,t)},r.prototype.message=function(e,t){var n={type:"message",message:e};return this._send(n,!0,t)},r.prototype._send=function(t,i,c){var u=this;if(c=c||e,!this._ws||this._ws.readyState!==r.WebSocket.OPEN)return o(c)(new s("Failed to send message - server disconnected","disconnect"));t.id=++this._ids,n(t,function(e,n){if(e)return o(c)(e);if(!i)try{return u._ws.send(n)}catch(e){return o(c)(new s(e,"ws"))}var r={callback:c,timeout:null};u._settings.timeout&&(r.timeout=setTimeout(function(){return r.callback=null,r.timeout=null,c(new s("Request timed out","timeout"))},u._settings.timeout)),u._requests[t.id]=r;try{u._ws.send(n)}catch(e){return clearTimeout(u._requests[t.id].timeout),delete u._requests[t.id],o(c)(new s(e,"ws"))}})},r.prototype._hello=function(e,t){var n={type:"hello",version:"2"};e&&(n.auth=e);var o=this.subscriptions();return o.length&&(n.subs=o),this._send(n,!0,t)},r.prototype.subscriptions=function(){return Object.keys(this._subscriptions)},r.prototype.subscribe=function(e,t,n){var i=this;if(!e||"/"!==e[0])return o(n)(new s("Invalid path","user"));var c=this._subscriptions[e];if(c)return-1===c.indexOf(t)&&c.push(t),o(n)();if(this._subscriptions[e]=[t],!this._ws||this._ws.readyState!==r.WebSocket.OPEN)return o(n)();var u={type:"sub",path:e};return this._send(u,!0,function(t){return t&&delete i._subscriptions[e],n(t)})},r.prototype.unsubscribe=function(e,t,n){if(!e||"/"!==e[0])return o(n)(new s("Invalid path","user"));var i=this._subscriptions[e];if(!i)return o(n)();var c=!1;if(t){var u=i.indexOf(t);if(-1===u)return o(n)();i.splice(u,1),i.length||(delete this._subscriptions[e],c=!0)}else delete this._subscriptions[e],c=!0;if(!c||!this._ws||this._ws.readyState!==r.WebSocket.OPEN)return o(n)();var a={type:"unsub",path:e};return this._send(a,!0,function(e){return n()})},r.prototype._onMessage=function(e){var n=this;this._beat();var o=e.data,i=o[0];if("{"!==i){if(this._packets.push(o.slice(1)),"!"!==i)return;o=this._packets.join(""),this._packets=[]}this._packets.length&&(this._packets=[],this.onError(new s("Received an incomplete message","protocol"))),t(o,function(e,t){if(e)return n.onError(e);var o=null;if(t.statusCode&&t.statusCode>=400&&t.statusCode<=599&&((o=new s(t.payload.message||t.payload.error||"Error","server")).statusCode=t.statusCode,o.data=t.payload,o.headers=t.headers,o.path=t.path),"ping"===t.type)return n._send({type:"ping"},!1);if("update"===t.type)return n.onUpdate(t.message);if("pub"!==t.type&&"revoke"!==t.type){var i=n._requests[t.id];if(!i)return n.onError(new s("Received response for unknown request","protocol"));var r=i.callback;if(clearTimeout(i.timeout),delete n._requests[t.id],r)return"request"===t.type?r(o,t.payload,t.statusCode,t.headers):"message"===t.type?r(o,t.message):"hello"===t.type?(n.id=t.socket,t.heartbeat&&(n._heartbeatTimeout=t.heartbeat.interval+t.heartbeat.timeout,n._beat()),r(o)):"sub"===t.type||"unsub"===t.type?r(o):n.onError(new s("Received unknown response type: "+t.type,"protocol"))}else{var c=n._subscriptions[t.path];if("revoke"===t.type&&delete n._subscriptions[t.path],c&&void 0!==t.message){var u={};"revoke"===t.type&&(u.revoked=!0);for(var a=0;a<c.length;++a)c[a](t.message,u)}}})},r.prototype._beat=function(){var e=this;this._heartbeatTimeout&&(clearTimeout(this._heartbeat),this._heartbeat=setTimeout(function(){e.onError(new s("Disconnecting due to heartbeat timeout","timeout")),e._ws.close()},this._heartbeatTimeout))},{Client:r}});